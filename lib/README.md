# npmdata — Developer Notes

This document covers the internal architecture for contributors working on this library.

## Module overview

| Module | Purpose |
|---|---|
| `publisher.ts` | `initPublisher()` — scaffolds a publishable package (updates `package.json`, generates bin script) |
| `consumer.ts` | `extract()` and `check()` — installs a package from the registry, copies files, manages marker files |
| `runner.ts` | Entry point injected into the generated bin script; delegates to the CLI |
| `cli.ts` / `main.ts` | CLI parsing and top-level entry point |
| `utils.ts` | File I/O helpers: glob matching via `minimatch`, SHA-256 hashing, CSV marker read/write, package manager detection |
| `types.ts` | Shared TypeScript types and constants (e.g. `DEFAULT_FILENAME_PATTERNS`) |

## Publish side (`publisher.ts`)

`initPublisher()` modifies the target `package.json` to include `files`, `bin`, and `dependencies` fields, then writes a thin `bin/npmdata.js` that calls `runner.run(__dirname)`. The generated script is kept minimal on purpose — all logic lives in this library.

## Consumer side (`consumer.ts`)

`extract()` flow:
1. Detects the package manager (`pnpm` / `yarn` / `npm`) via lock-file presence.
2. Runs `<pm> add <package>@<version>` in a temp location to resolve the package.
3. Iterates matching files (glob + optional content regex) from the installed package.
4. Copies files into `outputDir`, tracking state in a `.publisher` CSV marker file per output directory.
5. Optionally writes a `.gitignore` section around the managed files.

`check()` performs the same resolution but compares SHA-256 hashes without writing any files.

## Marker file (`.publisher`)

Each output directory that contains managed files gets a `.publisher` CSV file. Columns: `path`, `packageName`, `packageVersion`, `sha256`. This is the source of truth for drift detection and clean removal.

## Key design decisions

- No runtime dependencies beyond `semver` and `minimatch` to keep the consumer install footprint small.
- File identity is tracked by path + hash, not by timestamp, to be deterministic across machines.
- The bin script generated by `initPublisher` contains no logic; all behaviour is versioned inside this library.

## Dev workflow

```
make build lint-fix test
```

